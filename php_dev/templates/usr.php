<?php
?>
<svg style="display: none;">
  <symbol width="12" height="9" viewBox="0 0 12 9" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="edit-icon">
    <rect width="12" height="9" fill="url(#pattern0)"/>
    <defs>
      <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
        <use xlink:href="#image0_21_148" transform="translate(0 -0.166667) scale(0.0111111 0.0148148)"/>
      </pattern>
      <image id="image0_21_148" width="90" height="90" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAYAAAA4qEECAAAABmJLR0QA/wD/AP+gvaeTAAACbklEQVR4nO3cPU8UQRzH8S/oUfhWAGNiZbAw0hlfAK9BO42xMfGooMHYGFuIxMbC2FvoC/AlGB+QQs/GivAQoBhMCAzczO5//3uz+/sk090tc99M9mbvuAURERERERGZaDeAN8A2sAf8AtaBuTYn1TWPgQPgKDL2gYftTa07hsQDnx3P2ppgF6RGVuwaciMrdgVVIyt2hrqRFTuBVWTFvoR15P8jees3bfM6euslMJvywCsNT2RSfAKmgDvGx50GrgEfjI9bvCZOIT9dX0FBrGPv+k6/LJaxt5znXhyr2BveE2/b8GTkPqdO5APgusHci3E6mGfsRwZzL0Ys1GrmMZ5GjjFuPDeYezEuW41NxlZkmo+tyBcMy9iKPGZYxFbkxFEntiJnjipbv9znFM3ykjl3ZfdGE5+4KfYZTX0zotinNBlZsU94RO59bM/IbrEn7cvZIe3sWXda+JutaWMlH6GLEUW2psgOFNmBIjtQZAeK7ECRHSiyA0V2oMgOFNmBIjtQZAeK7ECRHSiyA0V2oMgOBsBNYBF4QvjhjEfkXv2bVswtFNnFgHB7HEV28Bedk118RZFdfEGnCxcf0Up28Q5FdrGGThcu7qLI5+TegWYeeEC4o8tFvgGfgRHwg3C1OCJs+3aAQ8JdW2KW6WjoXCvYrLpZ4B89WMlVTAHfsQvzwvBYnXIb2/PpksExOuk18Tevqj9LWERbuHMGhDc0y53CjNnsOuQ+47dlvf11k6W3pO2BFbumP6RfcCh2xNXEx+0nPGYLeE/4rEMqWiW+ekfAK2CBsM+WmmYIsbeB38AmcI+wGxEREREREZGSHQPj8GF34sUyJgAAAABJRU5ErkJggg=="/>
    </defs>
  </symbol>
  <symbol width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="delete-icon">
    <rect width="15" height="16" fill="url(#pattern0)"/>
    <defs>
      <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
        <use xlink:href="#image0_21_127" transform="translate(-0.0333333) scale(0.0118519 0.0111111)"/>
      </pattern>
      <image id="image0_21_127" width="90" height="90" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAYAAAA4qEECAAAABmJLR0QA/wD/AP+gvaeTAAAD3UlEQVR4nO3cS2sUWRQH8P+pfkTc6G4UpqGqIWuXfgQJOIyKs/ExmZ2CqLgQxYXJbGbQgdnrRhTFheKDGQh+gpmlunAT0lULDe4UESrdnb7HhQbaph/Vt09unzTnB9l0pw6n/ylO9b1VBDDGGGOMMcYYpWjaDfRK03QXgD+Y+QSAH8Y8/D0RPQRwLUmSDfnu/JWn3UAvZr4J4Lzn4fuY+RKAEoCLcl1NLpp2A92YmQCcFii1+K2WGhM1s76+vntjY+MvACcB7JFpSZ2PAB5UKpXLtVot9y0y0ejI8/xvIjozSY0dYC+Ac61WqwzgrG8R79HBzBER/ep7/E5DRKeZ2TsvVTN6lnkHTUSOme9JNqMZM98jIud7/EQzulqtXmq3220Ap/B1ls2iDwDuV6vVK9NuxBhjjDFmNLGNl0ajwVK1NKnX6yIZ2cowEAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EAs6EC1Bt4joKhHt//ZzFUDTo06zT52WcK9eVDxNSkTXkyS50fXSjSzLXjvnngKYK1imGUXR0TiOV7rrrK2tERH9KdetHy1n9N3eF+I4XiGinwEUec65BeCXnpABAER0R6C/iWkJuq8kSV4Q0REMD7sF4Hi9Xv+n35vlcrm0Lc2NSUXQzrnfBr2XJMmLKIqOof/MbkZRdGRQyADQbrcXJXqclIqgiWg5y7KFQe/HcbwSRdFRfB92v5n8nSzLFohoSbJXXyqCBjDnnHvWaDR+GvQLPTN74EzekqbpIefcExS/mG4rLUEDQBXAo2Fn9tYYGTUusixbYObnAHZtR6M+ND5uMPTiNkqapoeY+RmEQp7lxw2qAB4PGyODSIcsSWPQgEfYmkMG9AYNjBG29pAB3UHPFM1BF74oFlxBTpXWoMf+5qE9bI1Be3+90xy2tqBH7l1kWbZQZFEDv/3sbaMp6MLL6jGX6ypoCbrQmdy1rC68XIeSM1tF0ES0NGoXrs/dljnn3NNRu37MvCzZqy8VQaPPHZYtI3bhRu762R2WAgqu+IauIO0OS5d+d1jG3OocOLO13GHRsk3aYualUql0FwA6nc4iES1j/E37JjMv99T5HV//EF6ktkm1BK3WLO9HzyQLOhALOhALOhALOhALOhALOhALOhDJoD8L1tLik1QhyaDfCNbSQuwziQVNRA+kaiki9pnEgt7c3LwF4JVUPQVe5nl+W6qY6D+zXl1d/bFUKv0L4IBk3Sl4WalUDtdqtXdSBUW/dczPz7/tdDoHAVwA8D921gXyM4D/AJzP8/ygZMjGGGOMMcYYY4wxs+YLaxx5oXP3scAAAAAASUVORK5CYII="/>
    </defs>
  </symbol>
  <symbol width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" id="send">
    <g clip-path="url(#clip0_795_42)">
      <path d="M7.98633 22.1422C7.98633 22.286 8.06618 22.4179 8.19316 22.4851C8.32005 22.5522 8.47433 22.5436 8.59292 22.4624L11.2639 20.6386L7.98638 19.0764V22.1422H7.98633Z" fill="#353535"/>
      <path d="M23.8753 1.573C23.8019 1.50536 23.7072 1.46997 23.6115 1.46997C23.5538 1.46997 23.4963 1.48277 23.4418 1.50953L0.383235 12.8204C0.147551 12.9362 -0.00158724 13.1769 1.27467e-05 13.4402C0.00161274 13.7031 0.153272 13.9421 0.390653 14.0554L6.4678 16.9511L18.619 6.96376L7.97349 17.6685L15.5441 21.2757C15.6371 21.3203 15.7386 21.3424 15.8391 21.3424C15.9248 21.3424 16.0097 21.3268 16.0905 21.2951C16.2669 21.2253 16.407 21.0857 16.477 20.9093L23.9725 2.00034C24.0318 1.85154 23.9931 1.68141 23.8753 1.573Z" fill="#353535"/>
    </g>
    <defs>
      <clipPath id="clip0_795_42">
        <rect width="24" height="24" fill="white"/>
      </clipPath>
    </defs>
  </symbol>
</svg>
<script>
  // function deleteElement(id) {
  //   $.ajax({
  //     url: "set/delete-app.php",
  //     type: "POST",
  //     cashe: false,
  //     data:{
  //       appId: id
  //     }, // Отправка
  //     success:
  //       function (data) {
  //         alert(data); //print
  //       },
  //     error: function () {
  //       alert("Ошибка передачи. Возможно, были переданы некорреткные данные.");
  //     }
  //   });
  //   element = document.getElementById(id);
  //   element.remove();
  // }
  function sendSub() {
    $.ajax({
      url: "set/new-sub.php",
      type: "POST",
      cashe: false,
      data:{
        subId:$('#new-subject').val(),
        content:$('#sub-description').val()
      }, // Отправка
      success:
        location.reload(),
      error: function () {
        alert("Ошибка передачи. Возможно, были переданы некорреткные данные.");
      }
    });
    document.getElementById("new-sub").className = document.getElementById("new-sub").className + " hide";
  }

  function addNewFeed() {
    var m = $('#feed_content').val();
    $.ajax({
      url: "set/addFeedback.php",
      type: "POST",
      cashe: false,
      data:{
        feed_content: m
      }, // Отправка
      success:
        location.reload(),
      error: function () {
        alert("Ошибка передачи. Возможно, были переданы некорреткные данные.");
      }
    });
    console.log("success")

    var count = 1;
    let user_img = $(".main-header__photo").attr("src");

    let notion = document.createElement('li');
    notion.className = "usr__feed";
    notion.id = count++ + "feed";
    notion.innerHTML = "\<li class=\"usr__feed\"\>" +
    "<a class=\"usr__feed usr__feed--no-deco\" \>" +
      "<img class=\"usr__feed-img\" src=\"" + user_img + "\"" + "alt=\"s\">" +
     "<div class=\"usr__feed-box\">" +
     " <h2 class=\"usr__feed-head\">" + <?= "\"" .  $_SESSION['user_name'] . "\"" ?> + "<\/h2>" +
     "<p class=\"usr__feed-p\">" + m + "</p>" +
    "</div>" +
   " </a>" +
    "</li>";

    feedbacks.prepend(notion);
  }

  function deleteElement(id) {
    $.ajax({
      url: "set/delete-app.php",
      type: "POST",
      cashe: false,
      data:{
        appId: id
      }, // Отправка
      success:
        function (data) {
          alert(data); //print
        },
      error: function () {
        alert("Ошибка передачи. Возможно, были переданы некорреткные данные.");
      }
    });
    element = document.getElementById(id);
    element.remove();
  }
  function Dropdown(id) {
    document.getElementById(id).classList.toggle("show");
    var m = id + "del"
    document.getElementById(m).classList.toggle("hide");
  }
</script>
<main class="usr">
  <h2 class="user__heading">Профиль</h2>
  <div class="usr__main-box">
    <div class="usr__boxes">
      <div class="usr__person-box">
        <img src="<?= $user['url']; ?>" alt="<?= htmlspecialchars($user['name']); ?>" class="usr__img">
        <?php if ($my_account === 1): ?>
        <div id="image-edit">
          <label for="name" class="user-info__label">
            Изменить фото
          </label>
          <form method="post">
            <input type="file" name="image" class="image">
          </form>
        </div>
        <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Загрузка фото</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="img-container">
                  <div class="row">
                    <div class="col-md-8">
                      <!--  default image where we will set the src via jquery-->
                      <img id="image" src="">
                    </div>
                    <div class="col-md-4">
                      <div class="preview"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="crop">Загрузить</button>
              </div>
            </div>
          </div>
        </div>
        <?php endif; ?>
        <div class="usr__heading-box">
          <h1 class="usr__name"><?= htmlspecialchars($user['name']); ?><sub class="usr__online">в сети</sub></h1>
        </div>
        <h4 class="usr__status"><?= $user['info']; ?></h4>
        <?php if ($my_account === 0): ?>
          <a class="usr__btn" href="#messageBox">
            Написать
            <svg class="usr__send-icn">
              <use xlink:href="#send"></use>
            </svg>
          </a>
          <div class="usr__box-message" id="messageBox">
            <form class="usr__form-message" method="post" action="set/message-sent.php">
              <label class="usr__form-label">Сообщение</label>
              <textarea class="usr__message" placeholder="Текст сообщения" name="message" id="message"></textarea>
              <input class="usr__sent-btn" type="submit" value="отправить">
              <a class="usr__cancel" href="#">Отменить</a>
            </form>
          </div>
        <?php endif; ?>
        <?php if ($hide === 1): ?>
          <a class="usr__btn" href="#registerBanner">
            Написать
            <svg class="usr__send-icn">
              <use xlink:href="#send"></use>
            </svg>
          </a>
        <?php endif; ?>
      </div>
      <div class="usr__knowledge">
        <div class="usr__heading-box">
          <p class="usr__mini-heading">Знаю предметы</p>
          <img class="usr__icon" src="img/know.svg" alt="know">
        </div>
        <div>
          <ul class="user-info__feed-list">
          <?php foreach($userSubjects as $subject): ?>
            <?php $subid = rand(1, 1000); ?>
            <li class="user-info__feed">
              <div class="user-info__subject">
                <p><?= htmlspecialchars($subject['title']); ?></p>
                <?php if ($my_account === 1): ?>
                <img class="user-info__edit-pen" src="img/edit-pen.svg" alt="edit" onclick="Dropdown(<?= htmlspecialchars($subject['id']); ?>)">
                <?php endif; ?>
              </div>
            <div class="user-info__input-container">
              <div class="user-info__input" type="text" id="<?= htmlspecialchars($subject['id']) . "del" ?>"> <?= htmlspecialchars($subject['text']); ?></div>
              <?php if ($my_account === 1): ?>
              <form class="user__app-form user__app-form--edit" id="<?= htmlspecialchars($subject['id']); ?>" method="post" action="set/editSub.php">
                <label class="user__label user__label--wide">
                  <textarea class="user__max-width" type="text" name="content" placeholder="Подробнее опишите ваши навыки"><?= htmlspecialchars($subject['text']); ?></textarea>
                </label>
                <input type="hidden" name="ftp" value="<?= htmlspecialchars($subject['id']); ?>">
                <div class="user__max-width">
                  <input class="user__submit" type="submit" value="Сохранить">
                  <a class="user__submit user__submit--cancel close" onclick="Dropdown(<?= htmlspecialchars($subject['id']); ?>)">Отменить</a>
                </div>
              </form>
              <?php endif; ?>
            </div>
            </li>
          <?php endforeach; ?>
          </ul>
          <div class="user__form-container" id="new-sub">
            <form class="user__app-form" id="additionalForm">
              <h2 class="user__form-title">Добавление предмета в профиль</h2>
              <p>В каждой заявке высвечивается, в каких предметах ты разбираешься. Напиши подробно о том, в чем ты силен, чтобы быстрее найти человека, с которым ты обменяешься знаниями по заявке.</p>
              <div class="user__max-width">
                <label class="user__max-width">Предмет</label>
                <select name="new-subject" id="new-subject">
                  <?php foreach($subjects as $s): ?>
                    <option value="<?= $s['id']; ?>"><?= $s['title']; ?></option>
                  <?php endforeach; ?>
                </select>
              </div>
              <div class="user__max-width">
                <label class="user__max-width">Описание навыков</label>
                <textarea class="user__max-width" type="text" name="sub-description" id="sub-description" placeholder="Подробнее опишите проблему. Например: Я не понимаю, как решать параметр через производную."></textarea>
              </div>
              <div class="user__max-width">
                <input class="user__submit" type="button" onclick="sendSub()" value="Добавить">
                <a href="#" class="close">Отменить</a>
              </div>
            </form>
          </div>
        </div>
        <?php if ($my_account === 1): ?>
        <a class="usr__add-button" href="#new-sub">+ Добавить</a>
        <?php endif; ?>
      </div>
      <div class="usr__apps">
        <div class="usr__heading-box">
          <p class="usr__mini-heading">Заявки</p>
          <img class="usr__icon" src="img/aps.svg" alt="know">
        </div>
        <ul class="apps__list">
          <?php foreach ($apps as $app): ?>
            <li class="apps_item" id="<?= $app['appId'] ?>">
              <a class="apps__href">
                <div class="apps__content-container">
                  <div class="apps__head-content">
                    <h2 class="apps__heading">
                      <?= htmlspecialchars($app['title']); ?>
                    </h2>
                    <p class="apps__time">1 день назад</p>
                  </div>
                  <div class="apps__subject">
                    <?= htmlspecialchars($app['mainTitle']); ?>
                  </div>
                  <p class="apps__description">
                    <?= htmlspecialchars($app['content']); ?>
                  </p>
                  <div class="apps__footer-container">
                    <div class="apps__subjects-container">
                      <p class="apps__subjects-heading">Знаю:</p>
                      <?php foreach ($userSubjects as $u): ?>
                        <div class="apps__subject"><?= htmlspecialchars($u['title']); ?></div>
                      <?php endforeach; ?>
                    </div>
                    <div class="apps__feedback-container">
                      <p class="apps__feedback-text">1</p>
                    </div>
                  </div>
                </div>
              </a>
              <?php if ($my_account === 1): ?>
              <div class="apps__container-deleter" onclick="deleteElement(<?= $app['appId'] ?>)">
                <img class="apps__delete-icon" src="img/delete.svg" alt="delete">
                <p class="apps__delete-text">Удалить завку</p>
              </div>
              <?php endif; ?>
            </li>
          <?php endforeach; ?>
        </ul>
        <?php if ($my_account === 1): ?>
        <a class="usr__apps-button" href="#new-app">Создать заявку</a>
        <div class="user__form-container" id="new-app">
          <form class="user__app-form" action="application-add.php" method="post">
            <h2 class="user__form-title">Публикация заявки</h2>
            <div class="user__max-width">
              <label class="user__max-width">Название заявки</label>
              <input class="user__max-width" type="text" name="app-title" placeholder="Например: прошу помочь с экстремумами функции">
            </div>
            <div class="user__max-width">
              <label class="user__max-width">Предмет заявки</label>
              <select name="app-subject">
                <?php foreach($subjects as $s): ?>
                  <option value="<?= $s['id']; ?>"><?= $s['title']; ?></option>
                <?php endforeach; ?>
              </select>
            </div>
            <div class="user__max-width">
              <label class="user__max-width">Содержание заявки</label>
              <textarea class="user__max-width" type="text" name="app-description" placeholder="Подробнее опишите проблему. Например: Я не понимаю, как решать параметр через производную."></textarea>
            </div>
            <div class="user__max-width">
              <input class="user__submit" type="submit" value="Опубликовать">
              <a href="#" class="close">Отменить</a>
            </div>
          </form>
        </div>
        <?php endif; ?>
      </div>
      <div class="urs__feeds">
        <?php if ($my_account === 0): ?>
        <div class="user__form-container" id="new-feed">
          <form class="user__app-form" method="post" action="set/addFeedback.php">
            <h2 class="user__form-title">Оставить отзыв</h2>
            <p class="user__form-description">Отзыв будет виден всем пользователям</p>
            <div class="user__label">
              <label class="user__label">Содержание</label>
              <textarea class="user__max-width" type="text" name="feed_content" id="feed_content" placeholder="Подробнее опишите взаимодействие с пользователем"></textarea>
            </div>
            <div class="user__max-width">
              <a class="user__submit" onclick="addNewFeed()" href="javascript:history.back()">Добавить</a>
              <a class="user__submit user__submit--cancel close" href="#">Отменить</a>
            </div>
          </form>
        </div>
        <?php endif; ?>
        <div class="usr__heading-box">
          <p>Отзывы</p>
          <img class="usr__icon" src="img/sets.svg" alt="know">
        </div>
        <ul class="usr__feeds-list" id="feedbacks">
          <?php
          foreach ($feeds as $fd):
          $per_url = "user.php?" . http_build_query(["id" => $fd['identity']]);
            ?>
          <li class="usr__feed">
            <a class="usr__feed usr__feed--no-deco" href="<?= $per_url ?>">
            <img class="usr__feed-img" src="<?= $fd['url'] ?>" alt="<?= $fd['name'] ?>">
            <div class="usr__feed-box">
              <h2 class="usr__feed-head"><?= $fd['name'] ?></h2>
              <p class="usr__feed-p"><?= $fd['content'] ?></p>
            </div>
            </a>
          </li>
          <?php endforeach; ?>
        </ul>
        <?php if ($my_account === 0): ?>
        <a class="usr__add-button" href="#new-feed">+ оставить отзыв</a>
        <?php endif; ?>
      </div>
      <?php if ($my_account === 1): ?>
      <div class="usr__sets">
        <div class="usr__heading-box">
          <p>Настройки</p>
          <img class="usr__icon" src="img/sets.svg" alt="know">
        </div>
        <form method="post">
          <label>Скрыть профиль</label>
          <input type="checkbox">
        </form>
      </div>
      <?php endif; ?>
    </div>
  </div>
</main>
<script
  src="https://code.jquery.com/jquery-3.6.0.js"
  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
  crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="./cropperjs/cropper.min.js" type="text/javascript"></script>
<script>

  var bs_modal = $('#modal');
  var image = document.getElementById('image');
  var cropper,reader,file;


  $("body").on("change", ".image", function(e) {
    var files = e.target.files;
    var done = function(url) {
      image.src = url;
      bs_modal.modal('show');
    };


    if (files && files.length > 0) {
      file = files[0];

      if (URL) {
        done(URL.createObjectURL(file));
      } else if (FileReader) {
        reader = new FileReader();
        reader.onload = function(e) {
          done(reader.result);
        };
        reader.readAsDataURL(file);
      }
    }
  });

  bs_modal.on('shown.bs.modal', function() {
    cropper = new Cropper(image, {
      aspectRatio: 1,
      viewMode: 3,
      preview: '.preview'
    });
  }).on('hidden.bs.modal', function() {
    cropper.destroy();
    cropper = null;
  });

  $("#crop").click(function() {
    canvas = cropper.getCroppedCanvas({
      width: 200,
      height: 200,
    });

    canvas.toBlob(function(blob) {
      url = URL.createObjectURL(blob);
      var reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = function() {
        var base64data = reader.result;
        $.ajax({
          type: "POST",
          dataType: "json",
          url: "upload.php",
          data: {image: base64data},
          success: function(data) {
            bs_modal.modal('hide');
            alert("success upload image");
          }
        });
      };
    });
    bs_modal.modal('hide');
  });
</script>
